"""
Prediction model for F1 Prediction Analytics.

This module defines the Prediction SQLAlchemy model representing
ML model predictions for race winner probabilities.
"""

from datetime import datetime
from sqlalchemy import Column, Integer, String, ForeignKey, DateTime, Numeric, UniqueConstraint
from sqlalchemy.orm import relationship

from app.database import Base


class Prediction(Base):
    """
    SQLAlchemy model for Formula 1 race winner predictions.

    This model stores predictions generated by ML models for each driver's
    probability of winning a specific race. Predictions are versioned
    by model version to track performance over time.

    Attributes:
        prediction_id: Primary key, unique identifier for prediction
        race_id: Foreign key to the race being predicted
        driver_id: Foreign key to the driver
        predicted_win_probability: Probability percentage (0.00-100.00)
        model_version: Version of ML model that generated prediction
        prediction_timestamp: When prediction was generated
        created_at: Timestamp when record was created
    """

    __tablename__ = "predictions"

    prediction_id = Column(Integer, primary_key=True, index=True)
    race_id = Column(Integer, ForeignKey("races.race_id"), nullable=False, index=True)
    driver_id = Column(Integer, ForeignKey("drivers.driver_id"), nullable=False, index=True)
    predicted_win_probability = Column(
        Numeric(5, 2),
        nullable=False,
        # Ensure probability is between 0 and 100
        # Note: Check constraints will be added in Alembic migration
    )
    model_version = Column(String(50), nullable=False)
    prediction_timestamp = Column(DateTime, default=datetime.utcnow, index=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Ensure unique constraint: one prediction per driver per race per model version
    __table_args__ = (
        UniqueConstraint("race_id", "driver_id", "model_version", name="uq_prediction_race_driver_model"),
    )

    # Relationships
    race = relationship("Race", back_populates="predictions")
    driver = relationship("Driver", back_populates="predictions")

    def __repr__(self) -> str:
        """String representation of Prediction instance."""
        return (
            f"<Prediction(id={self.prediction_id}, race_id={self.race_id}, "
            f"driver_id={self.driver_id}, probability={self.predicted_win_probability}%, "
            f"model='{self.model_version}')>"
        )

    def __str__(self) -> str:
        """Human-readable string representation."""
        return f"{self.predicted_win_probability}% win probability"

    @property
    def high_probability(self) -> bool:
        """Check if prediction shows high win probability (>20%)."""
        return self.predicted_win_probability > 20.0

    @property
    def favorite(self) -> bool:
        """Check if this is a favorite prediction (>40%)."""
        return self.predicted_win_probability > 40.0

    @property
    def longshot(self) -> bool:
        """Check if this is a longshot prediction (<5%)."""
        return self.predicted_win_probability < 5.0

    @property
    def probability_decimal(self) -> float:
        """Return probability as decimal (0.0-1.0) for calculations."""
        return float(self.predicted_win_probability) / 100.0

    @classmethod
    def validate_probabilities_sum_to_100(cls, predictions: list) -> bool:
        """
        Validate that a set of predictions for a race sum to approximately 100%.

        Args:
            predictions: List of Prediction instances for the same race

        Returns:
            bool: True if probabilities sum to ~100% (within 0.1% tolerance)
        """
        if not predictions:
            return False

        total_probability = sum(p.predicted_win_probability for p in predictions)
        return abs(total_probability - 100.0) <= 0.1