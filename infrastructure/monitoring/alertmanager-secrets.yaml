# Alertmanager Secrets Configuration
# This file contains secret templates and configuration for Alertmanager authentication
# Actual secret values should be managed through CI/CD pipeline or secret management tools

apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: f1-analytics
  labels:
    app: alertmanager
    component: monitoring
type: Opaque
stringData:
  # SMTP password for email notifications
  # Replace with actual SMTP password or use external secret management
  smtp-password: "your-smtp-app-password-here"

  # Slack webhook URL for notifications
  # Replace with actual Slack webhook URL
  slack-webhook-url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

  # PagerDuty routing key for critical alerts
  # Replace with actual PagerDuty integration key
  pagerduty-routing-key: "your-pagerduty-routing-key"

  # Webhook bearer token for internal services
  # Replace with actual bearer token
  webhook-token: "your-webhook-bearer-token"

---
# ConfigMap for Alertmanager templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: f1-analytics
  labels:
    app: alertmanager
    component: monitoring
data:
  # Custom alert templates for better formatting
  default.tmpl: |
    {{ define "__subject" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]
    {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}
    {{ end }}

    {{ define "__description" }}{{ end }}

    {{ define "__text_alert_list" }}{{ range . }}
    *Alert:* {{ .Annotations.summary }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

    *Description:* {{ .Annotations.description }}

    *Details:*
      {{ range .Labels.SortedPairs }}â€¢ *{{ .Name }}:* `{{ .Value }}`
      {{ end }}
    {{ end }}{{ end }}

    {{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "slack.default.text" }}
    {{ if gt (len .Alerts.Firing) 0 }}*Alerts Firing:*
    {{ template "__text_alert_list" .Alerts.Firing }}{{ end }}
    {{ if gt (len .Alerts.Resolved) 0 }}*Alerts Resolved:*
    {{ template "__text_alert_list" .Alerts.Resolved }}{{ end }}
    {{ end }}

  # F1-specific alert templates
  f1-analytics.tmpl: |
    {{ define "f1.critical.title" }}ðŸš¨ F1 Analytics Critical Alert{{ end }}
    {{ define "f1.critical.text" }}
    *Critical Issue Detected in F1 Analytics Platform*

    {{ range .Alerts }}
    *Service:* {{ .Labels.service | title }}
    *Alert:* {{ .Annotations.summary }}
    *Impact:* {{ .Annotations.description }}

    {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
    {{ if .Annotations.dashboard_url }}*Dashboard:* {{ .Annotations.dashboard_url }}{{ end }}

    *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
    {{ if .EndsAt }}*Resolved:* {{ .EndsAt.Format "2006-01-02 15:04:05 UTC" }}{{ end }}
    {{ end }}
    {{ end }}

    {{ define "f1.ml.title" }}ðŸ¤– ML Service Alert - {{ .GroupLabels.alertname }}{{ end }}
    {{ define "f1.ml.text" }}
    *Machine Learning Service Alert*

    {{ range .Alerts }}
    *Model Performance Issue Detected*
    {{ .Annotations.summary }}

    *Details:* {{ .Annotations.description }}

    *Service:* {{ .Labels.service }}
    *Instance:* {{ .Labels.instance }}

    {{ if .Annotations.runbook_url }}
    *ðŸ“– Troubleshooting Guide:* {{ .Annotations.runbook_url }}
    {{ end }}
    {{ end }}
    {{ end }}

    {{ define "f1.data.title" }}ðŸ“Š Data Pipeline Alert - {{ .GroupLabels.alertname }}{{ end }}
    {{ define "f1.data.text" }}
    *Data Pipeline Issue*

    {{ range .Alerts }}
    {{ .Annotations.summary }}

    *Impact:* {{ .Annotations.description }}

    {{ if .Labels.dag_id }}*Airflow DAG:* {{ .Labels.dag_id }}{{ end }}
    {{ if .Labels.instance }}*Instance:* {{ .Labels.instance }}{{ end }}

    {{ if .Annotations.runbook_url }}
    *ðŸ”§ Resolution Steps:* {{ .Annotations.runbook_url }}
    {{ end }}
    {{ end }}
    {{ end }}

---
# Update Alertmanager deployment to mount secrets and templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-deployment-patch
  namespace: f1-analytics
  labels:
    app: alertmanager
    component: monitoring
data:
  # This ConfigMap documents the volume mount additions needed for the Alertmanager deployment
  # Add these volume mounts to the existing alertmanager deployment in grafana.yaml:

  # volumeMounts to add:
  volume-mounts.yaml: |
    - name: alertmanager-secrets
      mountPath: /etc/alertmanager/secrets
      readOnly: true
    - name: alertmanager-templates
      mountPath: /etc/alertmanager/templates
      readOnly: true

  # volumes to add:
  volumes.yaml: |
    - name: alertmanager-secrets
      secret:
        secretName: alertmanager-secrets
    - name: alertmanager-templates
      configMap:
        name: alertmanager-templates