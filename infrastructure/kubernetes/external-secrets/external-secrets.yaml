# External Secret definitions that pull from AWS Secrets Manager
# This replaces the hardcoded secrets.yaml file with secure external secret management

# PostgreSQL Database Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-secret
  namespace: f1-analytics
  labels:
    app: postgres
    component: database-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: postgres-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        username: "{{ .username }}"
        password: "{{ .password }}"
        database-url: "postgresql+psycopg2://{{ .username }}:{{ .password }}@postgres-service:5432/f1_analytics"
        replication-password: "{{ .replication_password }}"
  data:
  - secretKey: username
    remoteRef:
      key: f1-analytics/postgres
      property: username
  - secretKey: password
    remoteRef:
      key: f1-analytics/postgres
      property: password
  - secretKey: replication_password
    remoteRef:
      key: f1-analytics/postgres
      property: replication_password
---
# Redis Cache Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-secret
  namespace: f1-analytics
  labels:
    app: redis
    component: cache-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: redis-secret
    creationPolicy: Owner
  data:
  - secretKey: password
    remoteRef:
      key: f1-analytics/redis
      property: password
---
# Application Secrets (JWT, encryption keys)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-secrets
  namespace: f1-analytics
  labels:
    app: f1-analytics
    component: application-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: app-secrets
    creationPolicy: Owner
  data:
  - secretKey: jwt-secret
    remoteRef:
      key: f1-analytics/app
      property: jwt_secret
  - secretKey: app-secret-key
    remoteRef:
      key: f1-analytics/app
      property: app_secret_key
  - secretKey: db-encryption-key
    remoteRef:
      key: f1-analytics/app
      property: db_encryption_key
---
# External API Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: external-api-secrets
  namespace: f1-analytics
  labels:
    app: f1-analytics
    component: external-api-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: external-api-secrets
    creationPolicy: Owner
  data:
  - secretKey: openweather-api-key
    remoteRef:
      key: f1-analytics/external-apis
      property: openweather_api_key
  - secretKey: ergast-api-key
    remoteRef:
      key: f1-analytics/external-apis
      property: ergast_api_key
---
# Airflow Orchestration Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: airflow-secrets
  namespace: f1-analytics
  labels:
    app: airflow
    component: orchestration-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: airflow-secrets
    creationPolicy: Owner
  data:
  - secretKey: db-password
    remoteRef:
      key: f1-analytics/airflow
      property: db_password
  - secretKey: fernet-key
    remoteRef:
      key: f1-analytics/airflow
      property: fernet_key
  - secretKey: admin-password
    remoteRef:
      key: f1-analytics/airflow
      property: admin_password
  - secretKey: admin-username
    remoteRef:
      key: f1-analytics/airflow
      property: admin_username
---
# Monitoring Stack Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: monitoring-secrets
  namespace: f1-analytics
  labels:
    app: monitoring
    component: observability-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: monitoring-secrets
    creationPolicy: Owner
  data:
  - secretKey: grafana-admin-user
    remoteRef:
      key: f1-analytics/monitoring
      property: grafana_admin_user
  - secretKey: grafana-admin-password
    remoteRef:
      key: f1-analytics/monitoring
      property: grafana_admin_password
  - secretKey: prometheus-username
    remoteRef:
      key: f1-analytics/monitoring
      property: prometheus_username
  - secretKey: prometheus-password
    remoteRef:
      key: f1-analytics/monitoring
      property: prometheus_password
  - secretKey: slack-webhook-url
    remoteRef:
      key: f1-analytics/monitoring
      property: slack_webhook_url
  - secretKey: pagerduty-integration-key
    remoteRef:
      key: f1-analytics/monitoring
      property: pagerduty_integration_key
---
# Basic Auth for Staging Environment
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: staging-basic-auth
  namespace: f1-analytics-staging
  labels:
    app: f1-analytics
    component: staging-auth
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: staging-basic-auth
    creationPolicy: Owner
  data:
  - secretKey: auth
    remoteRef:
      key: f1-analytics/staging
      property: basic_auth